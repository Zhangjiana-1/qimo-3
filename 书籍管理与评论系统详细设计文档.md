# 书籍管理与评论系统详细设计文档

## 1. 引言

### 1.1 文档目的
本文档旨在详细描述书籍管理与评论系统的技术实现细节，包括系统架构、模块设计、数据库设计、界面设计等方面，为系统的编码实现提供具体指导。

### 1.2 文档范围
本文档涵盖了书籍管理与评论系统的详细设计内容，包括系统各层的具体实现、类的详细定义、接口设计、数据库设计以及界面原型设计等。

### 1.3 参考资料
- 《书籍管理与评论系统需求规格说明书》
- 《书籍管理与评论系统概要设计文档》

## 2. 系统架构详细设计

### 2.1 整体架构
系统采用前后端不分离的Spring Boot架构，遵循经典的MVC设计模式，具体分层如下：

1. **表现层(Presentation Layer)**
   - 负责用户界面展示
   - 使用Thymeleaf模板引擎在服务器端渲染HTML页面
   - 包含前端静态资源(CSS、JavaScript、图片等)

2. **控制层(Controller Layer)**
   - 处理HTTP请求，接收用户输入
   - 调用业务层进行逻辑处理
   - 返回视图或数据
   - 包含Controller、Interceptor、ExceptionHandler等组件

3. **业务逻辑层(Service Layer)**
   - 实现核心业务逻辑
   - 进行事务管理
   - 调用数据访问层进行数据操作
   - 包含Service接口和ServiceImpl实现类

4. **数据访问层(Repository Layer)**
   - 负责与数据库交互
   - 实现数据的CRUD操作
   - 使用Spring Data JPA/MyBatis框架
   - 包含Repository接口

5. **实体层(Entity Layer)**
   - 定义系统的核心数据模型
   - 与数据库表结构对应
   - 包含实体类和枚举类

6. **安全层(Security Layer)**
   - 实现用户认证和授权
   - 基于Spring Security框架
   - 包含认证、授权、加密等安全相关功能

7. **公共层(Common Layer)**
   - 提供系统通用功能和工具
   - 包含工具类、常量类、异常类等

### 2.2 技术栈详细说明

| 类别 | 技术/框架 | 版本 | 用途 |
|------|----------|------|------|
| 后端框架 | Spring Boot | 2.7.x | 应用程序主框架 |
| ORM框架 | Spring Data JPA | 2.7.x | 对象关系映射 |
| 安全框架 | Spring Security | 5.7.x | 用户认证与授权 |
| 前端模板 | Thymeleaf | 3.x | 服务器端页面渲染 |
| 前端样式 | Bootstrap | 5.x | 响应式UI框架 |
| 前端脚本 | jQuery | 3.x | DOM操作和AJAX请求 |
| 数据库 | MySQL | 8.0 | 数据存储 |
| 构建工具 | Maven | 3.8.x | 项目构建与依赖管理 |
| 版本控制 | Git | 2.x | 代码版本管理 |
| IDE | IntelliJ IDEA | 2022.x+ | 开发环境 |

### 2.3 项目目录结构设计

```
book-review-system/
├── src/
│   ├── main/
│   │   ├── java/com/example/bookreview/
│   │   │   ├── BookReviewApplication.java          # 应用程序入口
│   │   │   ├── config/
│   │   │   │   ├── SecurityConfig.java             # 安全配置
│   │   │   │   ├── WebConfig.java                  # Web配置
│   │   │   │   └── ThymeleafConfig.java            # Thymeleaf配置
│   │   │   ├── controller/
│   │   │   │   ├── UserController.java             # 用户控制器
│   │   │   │   ├── BookController.java             # 书籍控制器
│   │   │   │   ├── CommentController.java          # 评论控制器
│   │   │   │   ├── AdminController.java            # 管理员控制器
│   │   │   │   └── HomeController.java             # 首页控制器
│   │   │   ├── entity/
│   │   │   │   ├── User.java                       # 用户实体
│   │   │   │   ├── Book.java                       # 书籍实体
│   │   │   │   ├── Category.java                   # 分类实体
│   │   │   │   ├── Comment.java                    # 评论实体
│   │   │   │   ├── Collection.java                 # 收藏实体
│   │   │   │   ├── Role.java                       # 角色实体
│   │   │   │   └── dto/
│   │   │   │       ├── BookDTO.java                # 书籍数据传输对象
│   │   │   │       ├── CommentDTO.java             # 评论数据传输对象
│   │   │   │       └── UserDTO.java                # 用户数据传输对象
│   │   │   ├── repository/
│   │   │   │   ├── UserRepository.java             # 用户数据访问
│   │   │   │   ├── BookRepository.java             # 书籍数据访问
│   │   │   │   ├── CategoryRepository.java         # 分类数据访问
│   │   │   │   ├── CommentRepository.java          # 评论数据访问
│   │   │   │   ├── CollectionRepository.java       # 收藏数据访问
│   │   │   │   └── RoleRepository.java             # 角色数据访问
│   │   │   ├── service/
│   │   │   │   ├── UserService.java                # 用户服务接口
│   │   │   │   ├── BookService.java                # 书籍服务接口
│   │   │   │   ├── CommentService.java             # 评论服务接口
│   │   │   │   ├── CollectionService.java          # 收藏服务接口
│   │   │   │   └── impl/
│   │   │   │       ├── UserServiceImpl.java        # 用户服务实现
│   │   │   │       ├── BookServiceImpl.java        # 书籍服务实现
│   │   │   │       ├── CommentServiceImpl.java     # 评论服务实现
│   │   │   │       ├── CollectionServiceImpl.java  # 收藏服务实现
│   │   │   │       └── UserDetailsServiceImpl.java # Spring Security用户认证实现
│   │   │   ├── security/
│   │   │   │   ├── CustomUserDetails.java          # 自定义用户详情
│   │   │   │   └── JwtTokenProvider.java           # JWT令牌提供者（如果需要）
│   │   │   ├── util/
│   │   │   │   ├── DateUtils.java                  # 日期工具类
│   │   │   │   ├── StringUtils.java                # 字符串工具类
│   │   │   │   └── SecurityUtils.java              # 安全工具类
│   │   │   └── exception/
│   │   │       ├── GlobalExceptionHandler.java     # 全局异常处理器
│   │   │       ├── ResourceNotFoundException.java  # 资源未找到异常
│   │   │       └── BusinessException.java          # 业务异常
│   │   ├── resources/
│   │   │   ├── static/
│   │   │   │   ├── css/
│   │   │   │   ├── js/
│   │   │   │   ├── images/
│   │   │   │   └── libs/                          # 第三方库
│   │   │   ├── templates/
│   │   │   │   ├── common/
│   │   │   │   │   ├── header.html
│   │   │   │   │   ├── footer.html
│   │   │   │   │   └── sidebar.html
│   │   │   │   ├── home/
│   │   │   │   │   ├── index.html
│   │   │   │   │   └── search.html
│   │   │   │   ├── user/
│   │   │   │   │   ├── login.html
│   │   │   │   │   ├── register.html
│   │   │   │   │   ├── profile.html
│   │   │   │   │   └── collections.html
│   │   │   │   ├── book/
│   │   │   │   │   ├── list.html
│   │   │   │   │   └── detail.html
│   │   │   │   └── admin/
│   │   │   │       ├── dashboard.html
│   │   │   │       ├── users.html
│   │   │   │       ├── books.html
│   │   │   │       ├── comments.html
│   │   │   │       └── categories.html
│   │   │   ├── application.properties             # 应用配置文件
│   │   │   └── logback-spring.xml                 # 日志配置文件
│   └── test/
│       └── java/com/example/bookreview/            # 单元测试和集成测试
├── pom.xml                                         # Maven项目依赖配置
└── README.md                                       # 项目说明文档
```

## 3. 模块详细设计

### 3.1 用户管理模块

#### 3.1.1 功能说明
负责用户的注册、登录、信息管理和权限控制等功能。

#### 3.1.2 核心类设计

**User实体类**
```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "username", nullable = false, unique = true, length = 50)
    private String username;
    
    @Column(name = "password", nullable = false, length = 255)
    private String password;
    
    @Column(name = "email", unique = true, length = 100)
    private String email;
    
    @Column(name = "phone", unique = true, length = 20)
    private String phone;
    
    @Column(name = "nickname", length = 50)
    private String nickname;
    
    @Column(name = "avatar", length = 255)
    private String avatar;
    
    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(
        name = "user_roles",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "role_id")
    )
    private Set<Role> roles = new HashSet<>();
    
    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @Column(name = "status", nullable = false)
    private Integer status;
    
    // getter and setter methods
}
```

**UserService接口**
```java
public interface UserService {
    User register(User user);
    User findByUsername(String username);
    User findByEmail(String email);
    User findById(Long id);
    User updateProfile(User user);
    User changePassword(Long userId, String oldPassword, String newPassword);
    void resetPassword(String email);
    boolean existsByUsername(String username);
    boolean existsByEmail(String email);
}
```

**UserController类**
```java
@Controller
@RequestMapping("/user")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/register")
    public String showRegistrationForm(Model model) {
        model.addAttribute("user", new User());
        return "user/register";
    }
    
    @PostMapping("/register")
    public String registerUser(@Valid @ModelAttribute("user") User user, BindingResult result, Model model) {
        // 验证和注册逻辑
    }
    
    @GetMapping("/login")
    public String showLoginForm() {
        return "user/login";
    }
    
    @GetMapping("/profile")
    public String showProfile(Model model) {
        // 获取当前登录用户并展示个人资料
    }
    
    @PostMapping("/profile/update")
    public String updateProfile(@Valid @ModelAttribute("user") User user, BindingResult result) {
        // 更新用户资料逻辑
    }
    
    // 其他用户相关请求处理方法
}
```

#### 3.1.3 主要流程设计

**用户注册流程**
1. 用户访问注册页面
2. 填写注册信息（用户名、密码、邮箱等）
3. 提交表单
4. 系统验证信息合法性
5. 加密密码
6. 保存用户信息到数据库
7. 返回注册成功页面或自动登录

**用户登录流程**
1. 用户访问登录页面
2. 输入用户名/邮箱和密码
3. 提交表单
4. Spring Security验证凭证
5. 验证成功后，生成会话并跳转至首页
6. 验证失败，返回错误信息

### 3.2 书籍管理模块

#### 3.2.1 功能说明
负责书籍的添加、编辑、查询、浏览和收藏等功能。

#### 3.2.2 核心类设计

**Book实体类**
```java
@Entity
@Table(name = "books")
public class Book {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "isbn", unique = true, length = 20)
    private String isbn;
    
    @Column(name = "title", nullable = false, length = 255)
    private String title;
    
    @Column(name = "author", nullable = false, length = 100)
    private String author;
    
    @Column(name = "publisher", length = 100)
    private String publisher;
    
    @Column(name = "publish_date")
    private Date publishDate;
    
    @Column(name = "cover_url", length = 255)
    private String coverUrl;
    
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;
    
    @Column(name = "page_count")
    private Integer pageCount;
    
    @ManyToOne
    @JoinColumn(name = "category_id")
    private Category category;
    
    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    // getter and setter methods
}
```

**BookService接口**
```java
public interface BookService {
    List<Book> findAll();
    List<Book> findByCategoryId(Long categoryId);
    Book findById(Long id);
    Book save(Book book);
    void deleteById(Long id);
    List<Book> searchBooks(String keyword);
    List<Book> findPopularBooks(int limit);
    List<Book> findNewBooks(int limit);
    boolean existsByIsbn(String isbn);
    Book getBookByIsbn(String isbn);
}
```

**BookController类**
```java
@Controller
@RequestMapping("/books")
public class BookController {
    
    @Autowired
    private BookService bookService;
    
    @Autowired
    private CategoryRepository categoryRepository;
    
    @Autowired
    private CollectionService collectionService;
    
    @GetMapping
    public String listBooks(@RequestParam(required = false) Long categoryId,
                          @RequestParam(defaultValue = "1") int page,
                          Model model) {
        // 分页查询书籍列表
    }
    
    @GetMapping("/detail/{id}")
    public String showBookDetail(@PathVariable Long id, Model model) {
        // 获取书籍详情
    }
    
    @GetMapping("/search")
    public String searchBooks(@RequestParam String keyword, Model model) {
        // 搜索书籍
    }
    
    @PostMapping("/collect/{id}")
    public String collectBook(@PathVariable Long id) {
        // 收藏书籍
    }
    
    // 管理员相关操作
    @GetMapping("/admin/add")
    public String showAddBookForm(Model model) {
        // 显示添加书籍表单
    }
    
    @PostMapping("/admin/add")
    public String addBook(@Valid @ModelAttribute("book") Book book, BindingResult result) {
        // 添加书籍
    }
    
    // 其他书籍相关请求处理方法
}
```

### 3.3 评论管理模块

#### 3.3.1 功能说明
负责评论的发布、互动和管理等功能。

#### 3.3.2 核心类设计

**Comment实体类**
```java
@Entity
@Table(name = "comments")
public class Comment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @ManyToOne
    @JoinColumn(name = "user_id", nullable = false)
    private User user;
    
    @ManyToOne
    @JoinColumn(name = "book_id", nullable = false)
    private Book book;
    
    @Column(name = "content", nullable = false, columnDefinition = "TEXT")
    private String content;
    
    @Column(name = "rating")
    private Integer rating;
    
    @ManyToOne
    @JoinColumn(name = "parent_id")
    private Comment parentComment;
    
    @OneToMany(mappedBy = "parentComment")
    private List<Comment> replies = new ArrayList<>();
    
    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @Column(name = "status", nullable = false)
    private Integer status;
    
    // getter and setter methods
}
```

**CommentService接口**
```java
public interface CommentService {
    List<Comment> findByBookId(Long bookId);
    Comment save(Comment comment);
    Comment findById(Long id);
    void deleteById(Long id);
    List<Comment> findByStatus(Integer status);
    void updateStatus(Long id, Integer status);
}
```

## 4. 数据库详细设计

### 4.1 数据库连接配置

```properties
# 数据库连接配置
spring.datasource.url=jdbc:mysql://localhost:3306/book_review_system?useSSL=false&serverTimezone=UTC&characterEncoding=utf8
spring.datasource.username=root
spring.datasource.password=password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# JPA配置
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect
spring.jpa.properties.hibernate.format_sql=true
```

### 4.2 数据表详细定义

**users表**
```sql
CREATE TABLE `users` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码（加密存储）',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime NOT NULL COMMENT '更新时间',
  `status` int NOT NULL DEFAULT '1' COMMENT '状态（0：禁用，1：启用）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**books表**
```sql
CREATE TABLE `books` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '书籍ID',
  `isbn` varchar(20) DEFAULT NULL COMMENT 'ISBN号',
  `title` varchar(255) NOT NULL COMMENT '书名',
  `author` varchar(100) NOT NULL COMMENT '作者',
  `publisher` varchar(100) DEFAULT NULL COMMENT '出版社',
  `publish_date` date DEFAULT NULL COMMENT '出版日期',
  `cover_url` varchar(255) DEFAULT NULL COMMENT '封面URL',
  `description` text COMMENT '描述',
  `page_count` int DEFAULT NULL COMMENT '页数',
  `category_id` bigint DEFAULT NULL COMMENT '分类ID',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime NOT NULL COMMENT '更新时间',
  `status` int NOT NULL DEFAULT '1' COMMENT '状态（0：禁用，1：启用）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_isbn` (`isbn`),
  KEY `fk_category_id` (`category_id`),
  CONSTRAINT `fk_category_id` FOREIGN KEY (`category_id`) REFERENCES `categories` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**categories表**
```sql
CREATE TABLE `categories` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '分类ID',
  `name` varchar(50) NOT NULL COMMENT '分类名称',
  `description` varchar(255) DEFAULT NULL COMMENT '分类描述',
  `parent_id` bigint DEFAULT NULL COMMENT '父分类ID',
  `level` int DEFAULT NULL COMMENT '分类层级',
  `sort` int DEFAULT NULL COMMENT '排序',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_name` (`name`),
  KEY `fk_parent_id` (`parent_id`),
  CONSTRAINT `fk_parent_id` FOREIGN KEY (`parent_id`) REFERENCES `categories` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**comments表**
```sql
CREATE TABLE `comments` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '评论ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `book_id` bigint NOT NULL COMMENT '书籍ID',
  `content` text NOT NULL COMMENT '评论内容',
  `rating` int DEFAULT NULL COMMENT '评分（1-5星）',
  `parent_id` bigint DEFAULT NULL COMMENT '父评论ID（用于回复）',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime NOT NULL COMMENT '更新时间',
  `status` int NOT NULL DEFAULT '1' COMMENT '状态（0：待审核，1：正常，2：已删除）',
  PRIMARY KEY (`id`),
  KEY `fk_user_id` (`user_id`),
  KEY `fk_book_id` (`book_id`),
  KEY `fk_parent_id` (`parent_id`),
  CONSTRAINT `fk_comment_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`),
  CONSTRAINT `fk_comment_book_id` FOREIGN KEY (`book_id`) REFERENCES `books` (`id`),
  CONSTRAINT `fk_comment_parent_id` FOREIGN KEY (`parent_id`) REFERENCES `comments` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**collections表**
```sql
CREATE TABLE `collections` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '收藏ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `book_id` bigint NOT NULL COMMENT '书籍ID',
  `created_at` datetime NOT NULL COMMENT '收藏时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_book` (`user_id`,`book_id`),
  KEY `fk_collection_book_id` (`book_id`),
  CONSTRAINT `fk_collection_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`),
  CONSTRAINT `fk_collection_book_id` FOREIGN KEY (`book_id`) REFERENCES `books` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**roles表**
```sql
CREATE TABLE `roles` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '角色ID',
  `name` varchar(50) NOT NULL COMMENT '角色名称',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**user_roles表**
```sql
CREATE TABLE `user_roles` (
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `role_id` bigint NOT NULL COMMENT '角色ID',
  PRIMARY KEY (`user_id`,`role_id`),
  KEY `fk_user_roles_role_id` (`role_id`),
  CONSTRAINT `fk_user_roles_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`),
  CONSTRAINT `fk_user_roles_role_id` FOREIGN KEY (`role_id`) REFERENCES `roles` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 5. 界面详细设计

### 5.1 整体布局设计

系统采用响应式布局，整体页面结构如下：

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>书籍管理与评论系统</title>
    <!-- 引入CSS和JavaScript资源 -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header th:replace="common/header :: header"></header>
    
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <aside class="col-md-2 d-none d-md-block bg-light sidebar" th:replace="common/sidebar :: sidebar"></aside>
            
            <!-- 主内容区 -->
            <main role="main" class="col-md-10 ml-sm-auto px-4">
                <!-- 页面内容将在这里动态替换 -->
                <div layout:fragment="content"></div>
            </main>
        </div>
    </div>
    
    <!-- 底部 -->
    <footer th:replace="common/footer :: footer"></footer>
    
    <!-- 引入页面特定的JavaScript -->
    <script src="/js/main.js"></script>
</body>
</html>
```

### 5.2 主要页面设计

#### 5.2.1 首页设计

首页主要展示热门书籍推荐、新书上架、搜索框和分类导航等内容。

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layout}">
<head>
    <title>首页 - 书籍管理与评论系统</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- 搜索栏 -->
        <div class="search-bar my-4">
            <form action="/books/search" method="get">
                <div class="input-group">
                    <input type="text" name="keyword" class="form-control" placeholder="搜索书籍、作者、出版社..." required>
                    <button type="submit" class="btn btn-primary">搜索</button>
                </div>
            </form>
        </div>
        
        <!-- 分类导航 -->
        <div class="categories-nav mb-4">
            <ul class="nav nav-pills">
                <li class="nav-item"><a class="nav-link active" href="/books">全部分类</a></li>
                <li th:each="category : ${categories}" class="nav-item">
                    <a class="nav-link" th:href="@{/books(categoryId=${category.id})}" th:text="${category.name}"></a>
                </li>
            </ul>
        </div>
        
        <!-- 热门书籍 -->
        <div class="popular-books mb-6">
            <h2 class="text-center mb-4">热门书籍</h2>
            <div class="row">
                <div th:each="book : ${popularBooks}" class="col-md-3 col-sm-4 col-xs-6 mb-4">
                    <div class="book-card">
                        <a th:href="@{/books/detail/{id}(id=${book.id})}">
                            <img th:src="${book.coverUrl}" alt="封面" class="book-cover img-fluid">
                            <h4 th:text="${book.title}" class="book-title"></h4>
                            <p th:text="${book.author}" class="book-author"></p>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 新书上架 -->
        <div class="new-books">
            <h2 class="text-center mb-4">新书上架</h2>
            <div class="row">
                <div th:each="book : ${newBooks}" class="col-md-3 col-sm-4 col-xs-6 mb-4">
                    <div class="book-card">
                        <a th:href="@{/books/detail/{id}(id=${book.id})}">
                            <img th:src="${book.coverUrl}" alt="封面" class="book-cover img-fluid">
                            <h4 th:text="${book.title}" class="book-title"></h4>
                            <p th:text="${book.author}" class="book-author"></p>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
```

#### 5.2.2 书籍详情页设计

书籍详情页展示书籍的详细信息、用户评论，并提供收藏功能。

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layout}">
<head>
    <title>书籍详情 - 书籍管理与评论系统</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="book-detail">
            <div class="row">
                <!-- 书籍封面 -->
                <div class="col-md-3">
                    <img th:src="${book.coverUrl}" alt="书籍封面" class="book-cover-large img-fluid">
                    <div class="mt-4">
                        <button id="collect-btn" class="btn btn-primary btn-block"
                                th:classappend="${isCollected} ? 'btn-secondary' : 'btn-primary'"
                                th:text="${isCollected} ? '已收藏' : '添加收藏'">
                        </button>
                    </div>
                </div>
                
                <!-- 书籍信息 -->
                <div class="col-md-9">
                    <h1 th:text="${book.title}" class="book-title-large"></h1>
                    <p class="book-meta">
                        <span th:text="${book.author}" class="author"></span>
                        <span class="separator">/</span>
                        <span th:text="${book.publisher}" class="publisher"></span>
                        <span class="separator">/</span>
                        <span th:text="${#dates.format(book.publishDate, 'yyyy-MM-dd')}" class="publish-date"></span>
                    </p>
                    
                    <div class="book-info">
                        <p><strong>ISBN：</strong><span th:text="${book.isbn}"></span></p>
                        <p><strong>分类：</strong><span th:text="${book.category.name}"></span></p>
                        <p><strong>页数：</strong><span th:text="${book.pageCount}"></span></p>
                        <p><strong>描述：</strong><span th:text="${book.description}"></span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 评论区域 -->
        <div class="comments-section mt-6">
            <h2>用户评论</h2>
            
            <!-- 发表评论 -->
            <div class="add-comment mb-4" sec:authorize="isAuthenticated()">
                <form id="comment-form" th:action="@{/comments/add/{bookId}(bookId=${book.id})}" method="post">
                    <div class="form-group">
                        <label for="rating">评分：</label>
                        <select id="rating" name="rating" class="form-control w-auto">
                            <option value="1">1星</option>
                            <option value="2">2星</option>
                            <option value="3">3星</option>
                            <option value="4">4星</option>
                            <option value="5" selected>5星</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="content">评论内容：</label>
                        <textarea id="content" name="content" class="form-control" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发表评论</button>
                </form>
            </div>
            
            <!-- 评论列表 -->
            <div class="comment-list">
                <div th:each="comment : ${comments}" class="comment-item">
                    <div class="comment-header">
                        <img th:src="${comment.user.avatar}" alt="用户头像" class="user-avatar">
                        <div class="comment-info">
                            <span th:text="${comment.user.nickname}" class="username"></span>
                            <span th:text="${#dates.format(comment.createdAt, 'yyyy-MM-dd HH:mm:ss')}" class="comment-time"></span>
                            <div class="rating-stars" th:attr="data-rating=${comment.rating}"></div>
                        </div>
                    </div>
                    <div class="comment-content" th:text="${comment.content}"></div>
                    <div class="comment-actions">
                        <button class="reply-btn" th:attr="data-comment-id=${comment.id}">回复</button>
                        <button class="like-btn" th:attr="data-comment-id=${comment.id}">点赞</button>
                    </div>
                    
                    <!-- 回复列表 -->
                    <div class="replies" th:if="${comment.replies.size() > 0}">
                        <div th:each="reply : ${comment.replies}" class="reply-item">
                            <div class="reply-header">
                                <img th:src="${reply.user.avatar}" alt="用户头像" class="user-avatar-small">
                                <div class="reply-info">
                                    <span th:text="${reply.user.nickname}" class="username-small"></span>
                                    <span class="reply-to">回复</span>
                                    <span th:text="${comment.user.nickname}" class="reply-target"></span>
                                    <span th:text="${#dates.format(reply.createdAt, 'yyyy-MM-dd HH:mm:ss')}" class="reply-time"></span>
                                </div>
                            </div>
                            <div class="reply-content" th:text="${reply.content}"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 收藏功能
        $('#collect-btn').click(function() {
            // 收藏书籍的AJAX逻辑
        });
        
        // 评论提交
        $('#comment-form').submit(function(e) {
            // 表单提交前的验证
        });
        
        // 回复功能
        $('.reply-btn').click(function() {
            // 回复评论的逻辑
        });
        
        // 点赞功能
        $('.like-btn').click(function() {
            // 点赞评论的逻辑
        });
    </script>
</body>
</html>
```

## 6. 接口详细设计

### 6.1 HTTP接口设计

**用户管理接口**
| 接口名称 | 请求方法 | 请求路径 | 参数 | 响应 | 说明 |
|---------|---------|---------|------|------|------|
| 用户注册 | POST | /user/register | username, password, email, phone | 重定向到登录页 | 用户注册 |
| 用户登录 | POST | /login | username, password | 重定向到首页 | 用户登录 |
| 用户登出 | GET | /logout | 无 | 重定向到登录页 | 用户登出 |
| 查看个人资料 | GET | /user/profile | 无 | profile.html | 查看个人资料 |
| 更新个人资料 | POST | /user/profile/update | nickname, avatar, email, phone | 重定向到个人资料页 | 更新个人资料 |
| 修改密码 | POST | /user/password | oldPassword, newPassword | 成功消息 | 修改密码 |
| 重置密码 | POST | /user/reset-password | email | 成功消息 | 重置密码 |

**书籍管理接口**
| 接口名称 | 请求方法 | 请求路径 | 参数 | 响应 | 说明 |
|---------|---------|---------|------|------|------|
| 书籍列表 | GET | /books | categoryId, page | list.html | 获取书籍列表 |
| 书籍详情 | GET | /books/detail/{id} | id | detail.html | 获取书籍详情 |
| 搜索书籍 | GET | /books/search | keyword | search.html | 搜索书籍 |
| 收藏书籍 | POST | /books/collect/{id} | id | 成功消息 | 收藏书籍 |
| 我的收藏 | GET | /user/collections | 无 | collections.html | 查看我的收藏 |
| 添加书籍 | POST | /admin/books/add | isbn, title, author, publisher, etc. | 重定向到书籍列表 | 添加书籍（管理员） |
| 编辑书籍 | POST | /admin/books/edit/{id} | id, isbn, title, author, publisher, etc. | 重定向到书籍详情 | 编辑书籍（管理员） |
| 删除书籍 | POST | /admin/books/delete/{id} | id | 重定向到书籍列表 | 删除书籍（管理员） |

**评论管理接口**
| 接口名称 | 请求方法 | 请求路径 | 参数 | 响应 | 说明 |
|---------|---------|---------|------|------|------|
| 发表评论 | POST | /comments/add/{bookId} | bookId, content, rating | 重定向到书籍详情 | 发表评论 |
| 回复评论 | POST | /comments/reply/{id} | id, content | 重定向到书籍详情 | 回复评论 |
| 删除评论 | POST | /comments/delete/{id} | id | 成功消息 | 删除评论 |
| 评论管理 | GET | /admin/comments | 无 | comments.html | 评论管理（管理员） |
| 审核评论 | POST | /admin/comments/audit/{id} | id, status | 成功消息 | 审核评论（管理员） |

### 6.2 服务接口设计

**UserService接口**
```java
public interface UserService {
    /**
     * 用户注册
     * @param user 用户信息
     * @return 注册成功的用户
     */
    User register(User user);
    
    /**
     * 根据用户名查找用户
     * @param username 用户名
     * @return 用户信息
     */
    User findByUsername(String username);
    
    /**
     * 根据邮箱查找用户
     * @param email 邮箱
     * @return 用户信息
     */
    User findByEmail(String email);
    
    /**
     * 根据ID查找用户
     * @param id 用户ID
     * @return 用户信息
     */
    User findById(Long id);
    
    /**
     * 更新用户资料
     * @param user 用户信息
     * @return 更新后的用户信息
     */
    User updateProfile(User user);
    
    /**
     * 修改密码
     * @param userId 用户ID
     * @param oldPassword 旧密码
     * @param newPassword 新密码
     * @return 更新后的用户信息
     */
    User changePassword(Long userId, String oldPassword, String newPassword);
    
    /**
     * 重置密码
     * @param email 用户邮箱
     */
    void resetPassword(String email);
    
    /**
     * 检查用户名是否已存在
     * @param username 用户名
     * @return 是否存在
     */
    boolean existsByUsername(String username);
    
    /**
     * 检查邮箱是否已存在
     * @param email 邮箱
     * @return 是否存在
     */
    boolean existsByEmail(String email);
}
```

**BookService接口**
```java
public interface BookService {
    /**
     * 获取所有书籍
     * @return 书籍列表
     */
    List<Book> findAll();
    
    /**
     * 根据分类ID查找书籍
     * @param categoryId 分类ID
     * @return 书籍列表
     */
    List<Book> findByCategoryId(Long categoryId);
    
    /**
     * 根据ID查找书籍
     * @param id 书籍ID
     * @return 书籍信息
     */
    Book findById(Long id);
    
    /**
     * 保存书籍
     * @param book 书籍信息
     * @return 保存后的书籍信息
     */
    Book save(Book book);
    
    /**
     * 根据ID删除书籍
     * @param id 书籍ID
     */
    void deleteById(Long id);
    
    /**
     * 搜索书籍
     * @param keyword 搜索关键词
     * @return 书籍列表
     */
    List<Book> searchBooks(String keyword);
    
    /**
     * 获取热门书籍
     * @param limit 数量限制
     * @return 书籍列表
     */
    List<Book> findPopularBooks(int limit);
    
    /**
     * 获取新书
     * @param limit 数量限制
     * @return 书籍列表
     */
    List<Book> findNewBooks(int limit);
    
    /**
     * 检查ISBN是否已存在
     * @param isbn ISBN号
     * @return 是否存在
     */
    boolean existsByIsbn(String isbn);
    
    /**
     * 根据ISBN获取书籍信息
     * @param isbn ISBN号
     * @return 书籍信息
     */
    Book getBookByIsbn(String isbn);
}
```

## 7. 安全详细设计

### 7.1 Spring Security配置

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
                .antMatchers("/", "/css/**", "/js/**", "/images/**", "/books", "/books/detail/**", "/books/search").permitAll()
                .antMatchers("/user/register", "/user/reset-password").permitAll()
                .antMatchers("/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            .and()
                .formLogin()
                    .loginPage("/user/login")
                    .defaultSuccessUrl("/")
                    .permitAll()
            .and()
                .logout()
                    .logoutUrl("/logout")
                    .logoutSuccessUrl("/user/login")
                    .permitAll()
            .and()
                .csrf()
                    .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());
    }
    
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());
    }
}
```

### 7.2 用户认证实现

```java
@Service
public class UserDetailsServiceImpl implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userRepository.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("用户不存在");
        }
        
        Set<GrantedAuthority> authorities = new HashSet<>();
        for (Role role : user.getRoles()) {
            authorities.add(new SimpleGrantedAuthority("ROLE_" + role.getName()));
        }
        
        return new org.springframework.security.core.userdetails.User(
            user.getUsername(),
            user.getPassword(),
            user.getStatus() == 1, // 账户是否启用
            true, // 账户是否过期
            true, // 凭证是否过期
            true, // 账户是否锁定
            authorities
        );
    }
}
```

### 7.3 CSRF防护

Spring Security默认开启CSRF防护，在Thymeleaf模板中使用以下方式包含CSRF令牌：

```html
<form th:action="@{/some-action}" method="post">
    <!-- CSRF令牌会自动包含 -->
    <!-- 其他表单字段 -->
    <button type="submit">提交</button>
</form>

<!-- 对于AJAX请求 -->
<script>
    var csrfToken = [[${_csrf.token}]];
    var csrfHeader = [[${_csrf.headerName}]];
    
    $.ajax({
        url: '/some-action',
        type: 'post',
        beforeSend: function(xhr) {
            xhr.setRequestHeader(csrfHeader, csrfToken);
        },
        // 其他AJAX选项
    });
</script>
```

## 8. 部署详细设计

### 8.1 部署环境要求

| 环境 | 要求 | 说明 |
|------|------|------|
| JDK | 1.8+ | Java开发工具包 |
| MySQL | 8.0+ | 数据库服务器 |
| 操作系统 | Windows/Linux | 服务器操作系统 |
| 内存 | 4GB+ | 服务器内存 |
| 磁盘空间 | 50GB+ | 应用程序和数据存储空间 |

### 8.2 构建与部署流程

1. **构建项目**
   ```bash
   mvn clean package
   ```
   构建完成后，会在target目录下生成可执行的JAR文件。

2. **数据库初始化**
   - 创建MySQL数据库：`CREATE DATABASE book_review_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
   - 创建数据库用户并授权
   - 执行SQL脚本初始化数据表结构

3. **应用程序配置**
   - 创建application.properties文件，配置数据库连接信息、服务器端口等
   ```properties
   # 数据库配置
   spring.datasource.url=jdbc:mysql://localhost:3306/book_review_system?useSSL=false&serverTimezone=UTC&characterEncoding=utf8
   spring.datasource.username=root
   spring.datasource.password=password
   
   # 服务器配置
   server.port=8080
   server.servlet.context-path=/book-review
   
   # 日志配置
   logging.level.root=INFO
   logging.level.com.example.bookreview=DEBUG
   ```

4. **启动应用程序**
   ```bash
   java -jar book-review-system-1.0.jar --spring.config.location=/path/to/application.properties
   ```

5. **配置反向代理（可选）**
   如果使用Nginx作为反向代理服务器，可以添加以下配置：
   ```nginx
   server {
       listen 80;
       server_name example.com;
       
       location /book-review {
           proxy_pass http://localhost:8080/book-review;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       }
   }
   ```

## 9. 性能优化详细设计

### 9.1 数据库优化

1. **索引优化**
   - 为频繁查询的字段创建索引，如users表的username、email字段
   - 为外键字段创建索引，如books表的category_id字段
   - 为经常用于排序、分组、连接的字段创建索引

2. **查询优化**
   - 使用分页查询，避免一次性加载大量数据
   - 使用延迟加载，避免不必要的关联查询
   - 使用JPQL/HQL查询代替原生SQL，提高代码可维护性
   - 合理使用缓存，减少数据库访问

3. **连接池配置**
   ```properties
   # 数据库连接池配置
   spring.datasource.hikari.maximum-pool-size=20
   spring.datasource.hikari.minimum-idle=5
   spring.datasource.hikari.connection-timeout=30000
   spring.datasource.hikari.idle-timeout=600000
   spring.datasource.hikari.max-lifetime=1800000
   ```

### 9.2 缓存优化

1. **Spring Cache配置**
   ```java
   @Configuration
   @EnableCaching
   public class CacheConfig {
       
       @Bean
       public CacheManager cacheManager() {
           ConcurrentMapCacheManager cacheManager = new ConcurrentMapCacheManager(
               "books", "categories", "popularBooks", "newBooks"
           );
           return cacheManager;
       }
   }
   ```

2. **在Service层使用缓存**
   ```java
   @Service
   public class BookServiceImpl implements BookService {
       
       @Autowired
       private BookRepository bookRepository;
       
       @Cacheable("books")
       @Override
       public Book findById(Long id) {
           return bookRepository.findById(id).orElse(null);
       }
       
       @Cacheable("popularBooks")
       @Override
       public List<Book> findPopularBooks(int limit) {
           // 获取热门书籍的实现
       }
       
       // 其他方法
   }
   ```

### 9.3 前端优化

1. **静态资源压缩和缓存**
   ```properties
   # 静态资源缓存配置
   spring.resources.cache.period=31536000
   
   # 启用Gzip压缩
   server.compression.enabled=true
   server.compression.mime-types=text/html,text/xml,text/plain,text/css,text/javascript,application/javascript
   ```

2. **图片优化**
   - 使用适当的图片格式和大小
   - 实现图片懒加载
   - 考虑使用CDN加速静态资源访问

3. **减少HTTP请求**
   - 合并CSS和JavaScript文件
   - 使用CSS Sprites技术
   - 使用字体图标代替图片图标

## 10. 测试计划

### 10.1 单元测试

使用JUnit和Mockito框架对各层进行单元测试：

1. **实体层测试**：测试实体类的属性、getter和setter方法
2. **数据访问层测试**：测试Repository接口的CRUD操作
3. **业务逻辑层测试**：测试Service层的业务逻辑
4. **控制器层测试**：测试Controller的请求处理逻辑

### 10.2 集成测试

使用Spring Boot Test框架进行集成测试：

1. **数据库集成测试**：测试数据库操作的正确性
2. **API集成测试**：测试HTTP接口的功能和性能
3. **安全集成测试**：测试认证和授权功能

### 10.3 功能测试

手动测试系统的核心功能：

1. **用户管理功能**：注册、登录、登出、个人资料管理等
2. **书籍管理功能**：浏览、搜索、查看详情、收藏等
3. **评论管理功能**：发表评论、回复、点赞等
4. **管理员功能**：用户管理、书籍管理、评论管理等

### 10.4 性能测试

使用JMeter等工具进行性能测试：

1. **并发测试**：测试系统在多用户并发访问下的性能表现
2. **负载测试**：测试系统在不同负载下的响应时间和吞吐量
3. **压力测试**：测试系统的最大承载能力

## 11. 开发计划和里程碑

### 11.1 开发阶段划分

1. **需求分析和设计阶段**（2周）
   - 需求细化和确认
   - 系统架构设计
   - 数据库设计
   - 界面原型设计

2. **编码实现阶段**（6周）
   - 搭建项目框架
   - 实现用户管理模块
   - 实现书籍管理模块
   - 实现评论管理模块
   - 实现管理员功能
   - 界面开发和集成

3. **测试和优化阶段**（2周）
   - 单元测试和集成测试
   - 功能测试
   - 性能测试
   - 问题修复和性能优化

4. **部署上线阶段**（1周）
   - 环境准备
   - 应用部署
   - 系统监控配置
   - 上线验证

### 11.2 里程碑

1. **项目启动**：完成项目初始化和团队组建
2. **架构设计完成**：完成系统架构和数据库设计
3. **核心功能实现**：完成用户、书籍、评论核心功能的编码实现
4. **测试通过**：所有测试用例通过，系统功能稳定
5. **系统上线**：系统正式上线运行

---

**文档版本**：1.0
**编写日期**：2023年XX月XX日
**审批人**：XXX